# 混合智能事件触发系统架构设计

## 文档信息

- **文档版本**: v4.0
- **创建日期**: 2026-01-09
- **最后更新**: 2026-01-11
- **作者**: aixtrade 团队
- **状态**: 设计阶段

---

## 1. 概述

### 1.1 系统定位

混合智能事件触发系统是一个**独立运行的事件通知服务**，通过**传统规则引擎**与**LLM智能推理**的混合架构，提供灵活、智能的事件监控和通知能力。

**核心特点**：
- 独立部署，不依赖其他业务系统
- 通过消息队列接收事件
- 支持多通道消息推送
- 智能语义理解与规则匹配

### 1.2 核心价值

- **降低配置门槛**：支持自然语言定义触发规则
- **智能语义理解**：LLM理解模糊表达、时序逻辑和领域术语
- **高性能保障**：传统规则引擎处理高频简单规则
- **多通道推送**：支持Telegram、企业微信、邮件等多种通知方式

### 1.3 设计原则

1. **性能优先**：简单规则使用传统引擎，确保低延迟
2. **独立自治**：无外部服务依赖，可独立部署
3. **类型隔离**：不同类型事件维护独立上下文，避免混淆
4. **灵活推送**：支持用户级、群组级通知配置

---

## 2. 整体架构

### 2.1 架构全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             外部系统                                         │
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│   │ 交易系统     │  │ 监控系统     │  │ 业务系统     │  │ 管理后台     │  │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│          │                 │                 │                  │          │
│          └─────────────────┴────────┬────────┘                  │          │
│                                     │                           │          │
│                                     ▼                           ▼          │
│                          ┌─────────────────┐         ┌─────────────────┐  │
│                          │   RabbitMQ      │         │   API Gateway   │  │
│                          │   消息队列       │         │   (规则管理)    │  │
│                          └────────┬────────┘         └────────┬────────┘  │
└───────────────────────────────────┼────────────────────────────┼──────────┘
                                    │                            │
                                    ▼                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    混合智能事件触发系统（核心）                                │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         API 管理层                                     │ │
│  │                                                                        │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │ │
│  │  │    规则管理      │  │    规则测试      │  │    执行历史       │    │ │
│  │  │  - CRUD 操作     │  │  - 干跑测试      │  │  - 触发记录       │    │ │
│  │  │  - 启用/禁用     │  │  - 语法验证      │  │  - 决策日志       │    │ │
│  │  │  - 热更新广播    │  │  - 规则模拟      │  │  - 性能统计       │    │ │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        消息接收层                                       │ │
│  │  - 订阅指定队列/交换器                                                  │ │
│  │  - 消息反序列化和验证                                                   │ │
│  │  - 消息幂等性处理                                                       │ │
│  │  - 提取事件类型、context_key                                            │ │
│  └────────────────────────────┬──────────────────────────────────────────┘ │
│                               │                                             │
│                               ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      Redis 存储层                                       │ │
│  │                                                                        │ │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐          │ │
│  │  │   规则存储     │  │  上下文窗口     │  │   辅助存储     │          │ │
│  │  │                │  │                │  │                │          │ │
│  │  │ - 规则配置     │  │ - 按context_key│  │ - 幂等去重     │          │ │
│  │  │ - 事件类型索引 │  │   分组存储     │  │ - LLM结果缓存  │          │ │
│  │  │ - 版本控制     │  │ - 滑动时间窗口 │  │ - 通知任务队列 │          │ │
│  │  │ - 热更新广播   │  │ - 自动过期清理 │  │ - 通知去重     │          │ │
│  │  └────────────────┘  └────────────────┘  └────────────────┘          │ │
│  │                                                                        │ │
│  └────────────────────────────┬──────────────────────────────────────────┘ │
│                               │                                             │
│                               ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      上下文管理层                                       │ │
│  │                                                                        │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │ │
│  │  │ 交易事件上下文   │  │ 告警事件上下文   │  │ 系统事件上下文   │       │ │
│  │  │ (滑动窗口)      │  │ (滑动窗口)      │  │ (滑动窗口)      │       │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘       │ │
│  │                                                                        │ │
│  │  - 按 context_key 分组存储到 Redis                                     │ │
│  │  - 维护时间窗口（默认5分钟）+ 数量限制                                  │ │
│  │  - 自动清理过期事件                                                     │ │
│  │  - 为 LLM 生成结构化上下文摘要                                          │ │
│  └────────────────────────────┬──────────────────────────────────────────┘ │
│                               │                                             │
│                               ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      规则匹配引擎层                                      │ │
│  │                                                                        │ │
│  │    ┌─────────────────────────────────────────────────────────┐        │ │
│  │    │                    智能分流器                            │        │ │
│  │    │  - 从 Redis 加载规则（带本地缓存）                        │        │ │
│  │    │  - 规则类型识别和复杂度分析                               │        │ │
│  │    │  - 规则优先级排序                                        │        │ │
│  │    └────────────┬─────────────────────────────┬───────────────┘        │ │
│  │                 │                             │                        │ │
│  │                 ▼                             ▼                        │ │
│  │    ┌──────────────────────┐    ┌──────────────────────────┐           │ │
│  │    │    传统规则引擎      │    │      LLM推理引擎          │           │ │
│  │    │                      │    │                          │           │ │
│  │    │ - 字段比较           │    │ - 上下文摘要生成          │           │ │
│  │    │ - 表达式求值         │    │ - Prompt构建             │           │ │
│  │    │ - 逻辑运算           │    │ - 模型推理（带缓存）      │           │ │
│  │    │                      │    │ - 决策解析               │           │ │
│  │    │ 延迟: <1ms           │    │ - 服务降级策略           │           │ │
│  │    └──────────────────────┘    │ 延迟: 100-200ms          │           │ │
│  │                 │              └──────────────────────────┘           │ │
│  │                 └────────────────────────┬────────────────┘           │ │
│  │                                          │                            │ │
│  └──────────────────────────────────────────┼────────────────────────────┘ │
│                                             │                              │
│                                             ▼                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        通知推送层                                       │ │
│  │                                                                        │ │
│  │  ┌────────────────────────────────────────────────────────────┐       │ │
│  │  │                    通知任务队列 (Redis)                     │       │ │
│  │  │  - 异步任务处理    - 失败重试（指数退避）   - 死信队列       │       │ │
│  │  └────────────────────────────┬───────────────────────────────┘       │ │
│  │                               │                                        │ │
│  │  ┌──────────────┐  ┌──────────┴───┐  ┌──────────────┐                │ │
│  │  │ Telegram Bot │  │  企业微信机器人 │  │  邮件推送    │                │ │
│  │  │ - 用户ID推送 │  │  - Webhook   │  │  - SMTP      │                │ │
│  │  │ - 群组推送   │  │  - 群组推送   │  │  - 批量发送  │                │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │ │
│  │                                                                        │ │
│  │  通知可靠性保障:                                                        │ │
│  │  - 通知去重（相同规则+context_key 冷却期）                               │ │
│  │  - 频率限制（每分钟/每小时上限）                                         │ │
│  │  - 失败重试和死信处理                                                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        可观测性层                                       │ │
│  │                                                                        │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │ │
│  │  │   指标监控   │  │   结构化日志  │  │   链路追踪   │                │ │
│  │  │              │  │              │  │              │                │ │
│  │  │ - 事件接收数 │  │ - 事件处理   │  │ - trace_id   │                │ │
│  │  │ - 规则触发数 │  │ - 规则匹配   │  │ - 全链路跟踪 │                │ │
│  │  │ - 通知发送数 │  │ - LLM决策    │  │ - 性能分析   │                │ │
│  │  │ - LLM延迟   │  │ - 通知结果   │  │              │                │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              通知接收端                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │  Telegram    │  │   企业微信   │  │   邮件客户端  │                      │
│  └──────────────┘  └──────────────┘  └──────────────┘                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流

```
事件数据流:
外部系统 → MQ → 消息接收 → 幂等检查 → 上下文更新(Redis) → 规则匹配 → 通知队列(Redis) → 推送 → 用户

规则管理流:
管理后台 → API → 规则存储(Redis) → 版本更新 → Pub/Sub广播 → Worker本地缓存刷新
```

---

## 3. 核心组件设计

### 3.1 API 管理层

**职责**：
- 提供规则的创建、查询、更新、删除等管理接口
- 支持规则的启用/禁用状态管理
- 提供规则测试和验证能力
- 查询规则执行历史和决策日志

**API 接口设计**：

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/rules` | POST | 创建规则 |
| `/api/v1/rules` | GET | 列出规则（支持分页、过滤） |
| `/api/v1/rules/{rule_id}` | GET | 获取单条规则详情 |
| `/api/v1/rules/{rule_id}` | PUT | 更新规则 |
| `/api/v1/rules/{rule_id}` | DELETE | 删除规则 |
| `/api/v1/rules/{rule_id}/status` | PATCH | 启用/禁用规则 |
| `/api/v1/rules/test` | POST | 干跑测试（不实际触发通知） |
| `/api/v1/rules/validate` | POST | 验证规则语法 |
| `/api/v1/rules/{rule_id}/history` | GET | 查询规则触发历史 |

**规则热更新机制**：
- 规则变更时通过 Redis Pub/Sub 广播更新通知
- Worker 实例订阅更新频道，实时刷新本地规则缓存
- 使用版本号机制确保缓存一致性

### 3.2 Redis 存储层

**职责**：
- 持久化存储规则配置
- 按 context_key 分组存储事件上下文
- 提供规则热更新的发布订阅机制
- 支持 LLM 结果缓存、通知任务队列等辅助功能

**存储分类**：

#### 3.2.1 规则存储

- **规则详情**：存储完整的规则配置信息
- **规则索引**：按事件类型建立规则索引，加速规则查询
- **版本控制**：全局版本号用于缓存失效判断
- **热更新广播**：通过 Pub/Sub 通知 Worker 实例刷新缓存

#### 3.2.2 上下文窗口存储

- **分组策略**：按 `context_key` 分组存储事件
- **时间窗口**：使用有序集合，以时间戳为分数，支持范围查询
- **自动清理**：基于时间窗口和数量限制自动清理过期事件
- **TTL 管理**：设置 key 过期时间，防止孤儿数据

#### 3.2.3 辅助存储

- **幂等去重**：存储已处理的 event_id，防止重复处理
- **LLM 结果缓存**：缓存相似上下文的 LLM 推理结果
- **通知任务队列**：异步处理通知发送任务
- **通知去重**：记录已发送通知，支持冷却期去重

### 3.3 消息接收层

**职责**：
- 订阅RabbitMQ指定队列
- 解析消息并提取关键信息
- 验证消息格式和必填字段

**关键设计**：
- 消息必须包含：`event_type`（事件类型）
- 消息建议包含：`context_key`（上下文分组键）
- 通知对象由规则配置提供，不在事件消息中传递

**context_key 规范**：
- 由业务服务指定，用于上下文窗口划分
- 必须稳定且低基数，避免使用时间戳、订单号等高基数字段
- 缺省策略：未提供时退化为 `event_type`
- 推荐格式：使用点号分隔，如 `{event_type}.{symbol}.{strategy}`
- 示例：`trade.profit.BTCUSDT.MACD_Strategy`

**消息格式示例**：
```json
{
  "event_type": "trade.profit",
  "context_key": "trade.profit.BTCUSDT.MACD_Strategy",
  "timestamp": "2026-01-09T14:30:00Z",
  "data": {
    "symbol": "BTCUSDT",
    "profit": 1250.50,
    "profit_rate": 0.125
  }
}
```

### 3.4 上下文管理层

**职责**：
- 按 context_key 维护独立的上下文窗口
- 管理滑动时间窗口（默认5分钟）+ 数量限制
- 自动清理过期事件
- 为 LLM 推理生成结构化上下文摘要

**关键设计**：
- **类型隔离**：`trade.profit`和`system.alert`事件存储在不同上下文中
- **窗口大小**：时间窗口和事件数量双重限制
- **摘要生成**：为LLM推理生成结构化上下文摘要
- **分组键**：使用 `context_key` 划分上下文；`event_id` 仅用于幂等/追踪

**上下文摘要示例**：
```
事件类型: trade.profit
时间范围: 14:25:00 - 14:30:00 (5分钟)
事件总数: 8

最近8次交易盈利情况:
1. 14:25:15 BTCUSDT +1250.50 (+12.5%)
2. 14:26:30 ETHUSDT +850.20 (+8.5%)
3. 14:27:45 BTCUSDT -320.00 (-3.2%)
4. 14:28:10 SOLUSDT +450.30 (+4.5%)
5. 14:28:50 BTCUSDT +680.10 (+6.8%)
6. 14:29:15 ETHUSDT +920.40 (+9.2%)
7. 14:29:40 BTCUSDT +1100.20 (+11.0%)
8. 14:30:00 BTCUSDT +1250.50 (+12.5%)

统计:
- 总盈利: +4981.20
- 盈利次数: 7次，亏损次数: 1次
- 平均盈利率: +8.9%
- 趋势: 最近5次连续盈利
```

### 3.5 规则匹配引擎层

#### 3.5.1 智能分流器

**职责**：
- 识别规则类型（传统/LLM）
- 分析规则复杂度
- 路由到合适的引擎

**分流策略**：
- 简单条件判断 → 传统规则引擎
- 时序逻辑、语义理解 → LLM推理引擎
- 混合规则 → 传统引擎预筛选 + LLM深度分析

#### 3.5.2 传统规则引擎

**职责**：
- 处理简单的字段比较和逻辑运算
- 提供毫秒级响应

**适用场景**：
- 单次事件判断（如：盈利率 > 10%）
- 简单的状态检查（如：交易状态 = "completed"）
- 阈值告警（如：价格 < 40000）

**规则示例**：
```
当 profit_rate > 0.1 时，通知用户
当 price < 40000 时，发送告警
```

#### 3.5.3 LLM推理引擎

**职责**：
- 理解复杂的自然语言规则
- 分析时序模式和趋势
- 支持模糊表达和领域术语

**适用场景**：
- 时序模式识别（如：连续3次盈利）
- 趋势判断（如：价格快速下跌）
- 复杂条件组合（如：MACD金叉且成交量放大）
- 模糊表达（如：异常波动、大幅下跌）

**规则示例**：
```
当策略连续3次盈利且累计收益超过15%时，通知我
当价格在5分钟内快速下跌超过5%时，发送告警
当MACD出现金叉且成交量明显放大时，通知我
当市场出现异常波动时，发送警告
```

**Prompt构建策略**：
```
你是一个专业的交易事件分析助手。

用户规则:
{user_natural_language_rule}

历史上下文:
{structured_event_summary}

当前事件:
类型: {event.type}
时间: {event.timestamp}
数据: {event.data}

请分析当前事件是否满足用户规则，输出JSON格式决策:
{
  "should_trigger": true/false,
  "confidence": 0.0-1.0,
  "reason": "详细解释原因"
}
```

#### 3.5.4 规则类型与触发策略

系统设计了两个独立的概念来优化 LLM 使用：**规则类型**（架构层面）和 **触发模式**（执行策略层面）。

---

### 一、规则类型（Rule Type）

规则类型定义了事件处理的架构模式，决定如何组合传统引擎和 LLM 引擎。

#### 类型1：Traditional（传统规则）

纯基于表达式的规则引擎，不使用 LLM。

```json
配置示例:
{
  "rule_type": "traditional",
  "pre_filter": {
    "type": "expression",
    "expression": "profit_rate > 0.1"
  }
}

处理流程:
事件 → 表达式求值 → 触发/不触发
```

**特点**：
- 执行速度极快（<1ms）
- 零 LLM 成本
- 仅支持简单条件判断

**适用场景**：
- 简单阈值告警（价格 > 50000）
- 状态检查（status == "failed"）

---

#### 类型2：LLM（智能规则）

纯使用 LLM 进行智能推理，不使用传统规则预筛选。

```json
配置示例:
{
  "rule_type": "llm",
  "llm_config": {
    "description": "当价格在5分钟内快速下跌超过5%时发送告警",
    "trigger_mode": "realtime",
    "confidence_threshold": 0.7
  }
}

处理流程:
事件 → [触发模式检查] → LLM推理 → 触发/不触发
```

**特点**：
- 支持复杂语义理解
- 理解时序模式和趋势
- LLM 成本取决于触发模式

**适用场景**：
- 复杂时序判断（连续3次盈利）
- 模糊语义（"异常波动"、"快速下跌"）
- 需要上下文分析的场景

---

#### 类型3：Hybrid（混合规则）⭐ **推荐**

传统规则预筛选 + LLM 深度分析，两阶段处理。

```json
配置示例:
{
  "rule_type": "hybrid",
  "pre_filter": {
    "type": "expression",
    "expression": "profit_rate > 0.05"
  },
  "llm_config": {
    "description": "连续3次盈利且累计收益超过10%",
    "trigger_mode": "batch",
    "batch_size": 5,
    "max_wait_seconds": 30,
    "confidence_threshold": 0.7
  }
}

处理流程:
事件 → 表达式预筛选 → [不通过:丢弃]
              ↓ [通过]
         触发模式检查 → LLM推理 → 触发/不触发
```

**特点**：
- 大部分无关事件被快速过滤（<1ms）
- 显著降低 LLM 调用次数（可减少 80-90%）
- 保留智能分析能力

**适用场景**：
- 高频事件 + 智能判断（价格更新事件）
- 需要先初步筛选再深度分析

---

### 二、LLM 触发模式（Trigger Mode）

**仅适用于 `llm` 和 `hybrid` 规则类型**。触发模式控制何时执行 LLM 推理，用于优化性能和成本。

#### 模式1：Realtime（实时模式）

每个事件（或通过预筛选的事件）都触发 LLM 分析。

```json
配置:
{
  "trigger_mode": "realtime"
}
```

- **执行频率**：每个事件
- **响应延迟**：极低（100-200ms）
- **LLM成本**：⭐⭐⭐⭐⭐ 很高
- **适用场景**：低频高价值事件、必须即时响应

---

#### 模式2：Batch（批量模式）

累积事件，达到阈值后批量分析。

```json
配置:
{
  "trigger_mode": "batch",
  "batch_size": 10,
  "max_wait_seconds": 60
}

触发条件:
- 累积 10 个事件，或
- 距上次分析超过 60 秒
```

- **执行频率**：低
- **响应延迟**：中-高（最多 60秒）
- **LLM成本**：⭐⭐ 低
- **适用场景**：不需要实时响应、趋势分析

---

#### 模式3：Interval（间隔模式）

定期分析上下文窗口，不论是否有新事件。

```json
配置:
{
  "trigger_mode": "interval",
  "interval_seconds": 30
}

执行策略:
- 每 30 秒分析一次当前上下文
```

- **执行频率**：固定周期
- **响应延迟**：固定（30秒）
- **LLM成本**：⭐⭐ 低
- **适用场景**：周期性监控、趋势检测

---

### 三、策略对比与推荐

#### 触发模式对比表

| 触发模式 | 执行频率 | 响应延迟 | LLM成本 | 适用场景 |
|---------|---------|---------|---------|----------|
| Realtime | 高 | 极低 | ⭐⭐⭐⭐⭐ 很高 | 低频高价值事件 |
| Batch | 低 | 中-高 | ⭐⭐ 低 | 趋势分析、批量处理 |
| Interval | 固定 | 固定 | ⭐⭐ 低 | 周期性监控 |

#### 推荐配置

| 场景 | 规则类型 | 触发模式 | 配置示例 |
|------|---------|---------|----------|
| **交易盈利告警** | Hybrid | Batch | `pre_filter: profit_rate > 0.05`<br>`trigger_mode: batch, batch_size: 5` |
| **价格异常检测** | LLM | Batch | `trigger_mode: batch, batch_size: 10, max_wait_seconds: 30` |
| **技术指标分析** | LLM | Interval | `trigger_mode: interval, interval_seconds: 30` |
| **重大事件告警** | LLM | Realtime | `trigger_mode: realtime` |
| **系统监控** | LLM | Interval | `trigger_mode: interval, interval_seconds: 30` |
| **简单阈值告警** | Traditional | - | 仅 `pre_filter`，无 LLM |

### 3.6 通知推送层

**职责**：
- 根据通知对象配置推送消息
- 通过 Redis 任务队列异步处理通知
- 处理推送失败和重试（指数退避）
- 支持多通道并行推送
- 通知去重和频率限制

**通知对象来源**：
- 来自规则配置的 `notify_policy.targets`
- 支持多种通知对象格式：
  - Telegram: `{type: "telegram", user_id: "123"}` 或 `{type: "telegram", chat_id: "-456"}`
  - 企业微信: `{type: "wecom", webhook_key: "xxx"}`
  - 邮件: `{type: "email", to: ["user@example.com"]}`

**通知可靠性保障**：
- **异步队列**：通知任务入队后异步处理，避免阻塞主流程
- **失败重试**：指数退避重试策略（1s, 2s, 4s...）
- **死信队列**：超过最大重试次数的任务进入死信队列，人工处理
- **通知去重**：相同规则 + context_key 的通知在冷却期内不重复发送
- **频率限制**：支持每分钟/每小时通知上限配置

**通道实现**：

#### 3.6.1 Telegram Bot
- 用户ID推送：`bot.send_message(user_id, message)`
- 群组推送：`bot.send_message(chat_id, message)`
- 支持Markdown格式
- 支持按钮和快捷操作

#### 3.6.2 企业微信机器人
- Webhook方式推送
- 支持文本、markdown、图文消息
- 支持@指定成员

#### 3.6.3 邮件推送
- SMTP协议发送
- 支持HTML格式
- 支持批量发送
- 支持附件（可选）

**推送消息格式**：
```
【交易盈利通知】

触发规则: 连续盈利告警
触发时间: 2026-01-09 14:30:00

决策原因:
最近5次交易连续盈利，累计收益率达到18.5%，超过设定的15%阈值。

详细数据:
- 总盈利: +4981.20 USDT
- 盈利次数: 7/8
- 最近5次: 全部盈利
- 累计收益率: 18.5%

建议: 考虑部分止盈以锁定利润
```

### 3.7 可观测性层

**职责**：
- 收集和暴露系统运行指标
- 记录结构化日志
- 支持全链路追踪

**监控指标**：

| 指标名称 | 类型 | 说明 |
|----------|------|------|
| `trigger_events_received_total` | Counter | 接收事件总数（按 event_type 标签） |
| `trigger_rules_matched_total` | Counter | 规则触发次数（按 rule_id 标签） |
| `trigger_notifications_sent_total` | Counter | 通知发送数（按 channel 标签） |
| `trigger_llm_latency_seconds` | Histogram | LLM 推理延迟 |
| `trigger_context_size` | Gauge | 上下文窗口事件数量 |
| `trigger_notification_failures_total` | Counter | 通知发送失败数 |

**结构化日志**：
- 事件处理日志：event_id、context_key、处理耗时
- 规则匹配日志：rule_id、匹配结果、置信度
- LLM 决策日志：推理输入摘要、决策结果、原因
- 通知发送日志：通道类型、发送结果、重试次数

**链路追踪**：
- 每个事件分配唯一 trace_id
- 全链路跟踪：消息接收 → 上下文更新 → 规则匹配 → 通知发送
- 支持跨服务追踪（与外部系统集成）

---

## 4. 关键流程

### 4.1 事件处理流程

```
1. 接收MQ消息
   ↓
2. 解析消息，提取 event_type、event_id、context_key
   ↓
3. 幂等检查（Redis）
   - 检查 event_id 是否已处理
   - 已处理则跳过，未处理则标记并继续
   ↓
4. 上下文更新（Redis）
   - 根据 context_key 路由到对应上下文
   - 将事件添加到上下文窗口（Sorted Set）
   - 清理过期事件
   ↓
5. 规则加载（带本地缓存）
   - 检查版本号，决定是否刷新缓存
   - 查询匹配该事件类型的规则列表
   ↓
6. 规则匹配（按优先级排序）
   a. 判断规则类型
   b. 路由到传统引擎或LLM引擎
   c. 执行规则匹配
   d. 收集匹配结果
   ↓
7. 通知处理
   a. 读取规则的 notify_policy
   b. 检查通知去重（冷却期）
   c. 检查频率限制
   d. 通知任务入队（Redis List）
   ↓
8. 异步通知发送
   - 从队列消费通知任务
   - 按通道类型分组并行推送
   - 失败重试（指数退避）
   ↓
9. 记录执行结果和指标
```

### 4.2 规则匹配流程（LLM引擎）

```
1. 获取事件类型对应的上下文窗口
   ↓
2. 生成结构化上下文摘要
   ↓
3. 构建LLM Prompt:
   - 用户规则描述
   - 历史上下文摘要
   - 当前事件数据
   ↓
4. 调用LLM模型推理
   ↓
5. 解析JSON输出:
   {
     "should_trigger": bool,
     "confidence": float,
     "reason": str
   }
   ↓
6. 置信度过滤:
   - confidence < 0.7: 丢弃
   - confidence >= 0.7: 触发通知
   ↓
7. 返回匹配结果
```

### 4.3 规则管理流程

```
创建/更新规则:
1. API 接收规则配置
   ↓
2. 验证规则语法和配置完整性
   ↓
3. 保存规则到 Redis
   - 更新规则详情 (HASH)
   - 更新事件类型索引 (SET)
   - 递增全局版本号
   ↓
4. 通过 Pub/Sub 广播规则更新事件
   ↓
5. Worker 实例收到通知
   - 对比本地版本号
   - 版本不一致则标记缓存失效
   - 下次规则查询时刷新缓存

删除规则:
1. API 接收删除请求
   ↓
2. 从 Redis 删除规则
   - 删除规则详情
   - 从事件类型索引中移除
   - 递增全局版本号
   ↓
3. 广播更新事件
```

---

## 5. 使用场景

### 5.1 场景1：交易盈利告警

**业务需求**：
当交易策略连续盈利3次且累计收益超过10%时，通过Telegram通知用户。

**配置**：
```json
{
  "name": "连续盈利告警",
  "rule_config": {
    "rule_type": "hybrid",
    "pre_filter": {
      "type": "expression",
      "expression": "profit_rate > 0.05"
    },
    "llm_config": {
      "description": "当策略连续3次盈利且累计收益超过10%时，通知我",
      "trigger_mode": "batch",
      "batch_size": 5,
      "max_wait_seconds": 30,
      "confidence_threshold": 0.7
    }
  },
  "event_types": ["trade.profit"],
  "notify_policy": {
    "targets": [{"type": "telegram", "user_id": "123456"}]
  }
}
```

**策略说明**：
- **规则类型**：Hybrid（混合）- 先过滤盈利率 > 5% 的事件
- **触发模式**：Batch（批量）- 累积 5 个事件或等待 30 秒后分析

**消息示例**：
```json
{
  "event_type": "trade.profit",
  "context_key": "trade.profit.MACD_Strategy",
  "data": {
    "strategy": "MACD_Strategy",
    "profit": 1250.50,
    "profit_rate": 0.125
  }
}
```

**触发条件**：
- 上下文中最近5次交易，有3次连续盈利
- 这3次的累计收益率 > 10%

**推送通知**：
```
【交易盈利通知】

触发规则: 连续盈利告警
策略: MACD_Strategy

决策原因:
最近3次交易连续盈利，累计收益率达到12.5%，超过设定的10%阈值。

详细数据:
- 本次盈利: +1250.50 USDT (+12.5%)
- 连续盈利次数: 3次
- 累计收益率: 12.5%
```

### 5.2 场景2：价格异常告警

**业务需求**：
当价格在5分钟内快速下跌超过5%时，通过企业微信和邮件同时通知团队。

**配置**：
```json
{
  "name": "价格快速下跌告警",
  "rule_config": {
    "rule_type": "llm",
    "llm_config": {
      "description": "当价格在5分钟内快速下跌超过5%时，发送告警",
      "trigger_mode": "interval",
      "interval_seconds": 30,
      "confidence_threshold": 0.7
    }
  },
  "event_types": ["price.update"],
  "notify_policy": {
    "targets": [
      {"type": "wecom", "webhook_key": "xxxxxx"},
      {"type": "email", "to": ["team@example.com"]}
    ]
  }
}
```

**策略说明**：
- **规则类型**：LLM（智能）- 纯 LLM 分析价格趋势
- **触发模式**：Interval（间隔）- 每 30 秒分析一次价格走势

**消息示例**：
```json
{
  "event_type": "price.update",
  "context_key": "price.update.BTCUSDT",
  "data": {
    "symbol": "BTCUSDT",
    "price": 40250.00,
    "change_rate": -0.053
  }
}
```

**触发条件**：
- 上下文窗口内（5分钟）价格从42500下跌到40250
- 跌幅: 5.3% > 5%

**推送通知**：
```
【价格异常告警】⚠️

触发规则: 价格快速下跌告警
交易对: BTCUSDT

决策原因:
价格在5分钟内从42500下跌至40250，跌幅5.3%，超过5%阈值。

详细数据:
- 起始价格: 42500
- 当前价格: 40250
- 跌幅: -5.3%
- 时间窗口: 5分钟

建议: 关注市场动态，评估止损策略
```

### 5.3 场景3：技术指标信号

**业务需求**：
当MACD出现金叉且成交量明显放大时，通知交易群组。

**配置**：
```json
{
  "name": "MACD金叉信号",
  "rule_config": {
    "rule_type": "llm",
    "llm_config": {
      "description": "当MACD出现金叉且成交量明显放大时，通知我",
      "trigger_mode": "realtime",
      "confidence_threshold": 0.8
    }
  },
  "event_types": ["indicator.update"],
  "notify_policy": {
    "targets": [{"type": "telegram", "chat_id": "-1001234567890"}]
  }
}
```

**策略说明**：
- **规则类型**：LLM（智能）- 理解技术指标的语义
- **触发模式**：Realtime（实时）- 指标更新频率低，需要即时响应

**消息示例**：
```json
{
  "event_type": "indicator.update",
  "context_key": "indicator.update.BTCUSDT",
  "data": {
    "symbol": "BTCUSDT",
    "macd": {
      "macd_line": 15.2,
      "signal_line": 12.8,
      "histogram": 2.4
    },
    "volume": 8500000,
    "avg_volume": 5000000
  }
}
```

**触发条件**：
- MACD线（15.2）上穿信号线（12.8），形成金叉
- 成交量（850万）明显高于平均成交量（500万），增幅70%

**推送通知**：
```
【技术指标信号】📈

触发规则: MACD金叉 + 成交量放大
交易对: BTCUSDT

决策原因:
MACD线(15.2)上穿信号线(12.8)，形成金叉。同时成交量(850万)较平均值(500万)放大70%，显示强烈买入信号。

技术指标:
- MACD差值: +2.4 (向上)
- 成交量: 850万 (平均的1.7倍)
- 信号强度: 高

建议: 考虑建仓或加仓
```

### 5.4 场景4：系统监控告警

**业务需求**：
当系统CPU使用率超过80%时，立即通知运维团队。

**配置**：
```json
{
  "name": "CPU使用率告警",
  "rule_config": {
    "rule_type": "traditional",
    "pre_filter": {
      "type": "expression",
      "expression": "cpu_usage > 0.8"
    }
  },
  "event_types": ["system.metrics"],
  "notify_policy": {
    "targets": [
      {"type": "email", "to": ["ops@example.com"]},
      {"type": "telegram", "user_id": "789012"}
    ]
  }
}
```

**策略说明**：
- **规则类型**：Traditional（传统）- 简单阈值判断，无需 LLM
- **触发模式**：无 - 传统规则直接触发

**消息示例**：
```json
{
  "event_type": "system.metrics",
  "context_key": "system.metrics.trading-server-01",
  "data": {
    "host": "trading-server-01",
    "cpu_usage": 0.85,
    "memory_usage": 0.72
  }
}
```

**触发条件**：
- cpu_usage (85%) > 80%

**推送通知**：
```
【系统告警】⚠️

触发规则: CPU使用率过高
主机: trading-server-01

告警详情:
- CPU使用率: 85%
- 内存使用率: 72%
- 持续时间: 5分钟

建议: 检查进程占用，考虑扩容
```

---

## 6. 部署架构

### 6.1 单机部署

```
┌───────────────────────────────────────────┐
│              Docker Host                   │
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │      Trigger System Service         │  │
│  │  - API 管理层                        │  │
│  │  - 消息接收层                        │  │
│  │  - 规则匹配引擎                      │  │
│  │  - 通知推送层                        │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │            Redis                     │  │
│  │  - 规则存储                          │  │
│  │  - 上下文窗口                        │  │
│  │  - 通知队列                          │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │         LLM 推理服务                 │  │
│  │   (本地 Ollama / 远程 API)          │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │           RabbitMQ                  │  │
│  └─────────────────────────────────────┘  │
│                                           │
└───────────────────────────────────────────┘
```

### 6.2 分布式部署（推荐生产环境）

```
                        ┌─────────────────────────────┐
                        │       API Gateway           │
                        │    (规则管理、健康检查)      │
                        └─────────────┬───────────────┘
                                      │
┌─────────────────────────────────────┼─────────────────────────────────────┐
│                                     │                                     │
│  ┌──────────────────────────────────┴──────────────────────────────────┐ │
│  │                         Redis Cluster                                │ │
│  │   - 规则存储（主从复制）    - Pub/Sub（规则更新广播）                  │ │
│  │   - 上下文窗口存储          - 通知任务队列                            │ │
│  └──────────────────────────────────┬──────────────────────────────────┘ │
│                                     │                                     │
│          ┌──────────────────────────┼──────────────────────────┐         │
│          │                          │                          │         │
│          ▼                          ▼                          ▼         │
│   ┌────────────┐            ┌────────────┐            ┌────────────┐    │
│   │  Worker 1  │            │  Worker 2  │            │  Worker 3  │    │
│   │  (事件处理) │            │  (事件处理) │            │  (事件处理) │    │
│   │            │            │            │            │            │    │
│   │ 本地规则缓存│            │ 本地规则缓存│            │ 本地规则缓存│    │
│   └─────┬──────┘            └─────┬──────┘            └─────┬──────┘    │
│         │                         │                         │           │
│         └─────────────────────────┼─────────────────────────┘           │
│                                   │                                     │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        RabbitMQ Cluster                           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                   │                                     │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                       LLM 推理服务                                 │  │
│  │            (本地 Ollama / 远程 API，可独立部署)                     │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**分布式部署要点**：
- Worker 实例无状态，可水平扩展
- Redis 作为共享存储，支持多 Worker 协作
- 规则更新通过 Pub/Sub 实时同步到所有 Worker
- LLM 服务可独立部署，按需扩展

---

## 7. 总结

### 7.1 核心优势

1. **独立自治**：可独立部署和扩展，依赖组件（Redis、RabbitMQ）均可容器化
2. **智能灵活**：支持自然语言规则，降低配置门槛
3. **高性能**：混合架构保证简单规则的低延迟响应
4. **多通道推送**：支持Telegram、企业微信、邮件等多种通知方式
5. **类型隔离**：不同事件类型独立管理，避免上下文混淆
6. **API 管理**：提供完整的规则 CRUD 接口，支持热更新
7. **高可靠**：通知队列异步处理、失败重试、死信队列保障
8. **可观测**：完善的指标监控、结构化日志、链路追踪

### 7.2 适用场景

- 交易策略监控和告警
- 市场行情异常检测
- 系统运维监控
- 业务事件通知
- 任何需要智能事件触发的场景

### 7.3 扩展性

- 支持水平扩展（多Worker实例，无状态设计）
- 支持新增通知通道（插件化设计）
- 支持自定义事件类型
- 支持动态加载规则（Redis 存储 + Pub/Sub 热更新）
- 支持分布式部署（Redis Cluster + RabbitMQ Cluster）

---

## 文档变更记录

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-09 | aixtrade 团队 | 初始版本 |
| v2.0 | 2026-01-09 | aixtrade 团队 | 重构为独立服务架构，简化文档 |
| v3.0 | 2026-01-10 | aixtrade 团队 | 增加 API 管理层、Redis 存储层、可观测性层设计；完善通知可靠性机制 |
| v4.0 | 2026-01-11 | aixtrade 团队 | **重大修订**：明确区分**规则类型**（traditional/llm/hybrid）和**触发模式**（realtime/batch/interval）；实现完整的 trigger_mode 功能；更新所有场景示例 |

---

**END OF DOCUMENT**
